name: Update Clash Configuration

‰∫é:
  schedule:
    # ÊØèÈöî10ÂàÜÈíüËøêË°å‰∏ÄÊ¨°ÔºàÂåó‰∫¨Êó∂Èó¥Ôºâ
    - cron: '*/10 * * * *'
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
  push:
    paths:
      - '.github/workflows/update-clash.yaml'

permissions:
  contents: write

jobs:
  update-clash:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml

    - name: Get current Beijing time
      id: time
      run: |
        # Ëé∑ÂèñÂåó‰∫¨Êó∂Èó¥
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        echo "BEIJING_TIME=${BEIJING_TIME}" >> $GITHUB_OUTPUT
        
        # Ê†ºÂºèÂåñÊèê‰∫§Êó∂Èó¥
        COMMIT_TIME=$(TZ='Asia/Shanghai' date '+%H:%M:%S')
        echo "COMMIT_TIME=${COMMIT_TIME}" >> $GITHUB_OUTPUT
        
        # ÁîüÊàêÊó∂Èó¥Êà≥Áî®‰∫éÂ§áÊ≥®
        TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y%m%d%H%M%S')
        echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_OUTPUT

    - name: Fetch URLs from source
      id: fetch-urls
      run: |
        python << 'EOF'
        import requests
        import re
        
        # Ê∫êURL
        source_url = "https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi"
        
        try:
            response = requests.get(source_url, timeout=30)
            response.raise_for_status()
            content = response.text
            
            # ÊèêÂèñÊâÄÊúâÈùûÊ≥®ÈáäË°åÁöÑURL
            urls = []
            for line in content.split('\n'):
                line = line.strip()
                # Ë∑≥ËøáÁ©∫Ë°åÂíåÊ≥®ÈáäÔºà‰ª•#ÂºÄÂ§¥ÁöÑË°åÔºâ
                if not line or line.startswith('#'):
                    continue
                # Ê£ÄÊü•ÊòØÂê¶ÊòØÊúâÊïàÁöÑURL
                if re.match(r'^https?://', line):
                    urls.append(line)
            
            # ÂêàÂπ∂URLsÔºåÊØèË°å‰∏Ä‰∏™
            urls_text = '\n'.join(urls)
            
            # ËæìÂá∫Âà∞GitHub Actions
            with open('urls.txt', 'w', encoding='utf-8') as f:
                f.write(urls_text)
            
            print(f"Found {len(urls)} URLs")
            
            # ËÆæÁΩÆËæìÂá∫ÂèòÈáè
            import os
            os.system(f'echo "URLS_COUNT={len(urls)}" >> $GITHUB_OUTPUT')
            
        except Exception as e:
            print(f"Error fetching URLs: {e}")
            raise

EOF
      env:
        GITHUB_OUTPUT: /tmp/github_output

    - name: Convert URLs to Clash config via API
      id: convert
      run: |
        python << 'EOF'
        import requests
        import json
        import time
        
        # ËØªÂèñÊèêÂèñÁöÑURLs
        with open('urls.txt', 'r', encoding='utf-8') as f:
            urls_content = f.read()
        
        if not urls_content.strip():
            print("No URLs found, exiting...")
            exit(0)
        
        # APIÈÖçÁΩÆ
        api_base = "https://sublink.works/api/"
        worker_domain = "https://sublink-worker.schnappi6868.workers.dev/"
        
        # ÂáÜÂ§áËØ∑Ê±ÇÊï∞ÊçÆ
        payload = {
            "urls": urls_content,
            "target": "clash",
            "config": {
                "exclude": "",
                "include": "",
                "emoji": True,
                "udp": True,
                "tfo": False,
                "append_type": False,
                "sort": False,
                "rename": "",
                "include_remark": "",
                "exclude_remark": ""
            }
        }
        
        try:
            # Ë∞ÉÁî®APIËΩ¨Êç¢
            response = requests.post(
                api_base + "convert",
                json=payload,
                headers={
                    "Content-Type": "application/json",
                    "Origin": worker_domain,
                    "Referer": worker_domain
                },
                timeout=60
            )
            
            if response.status_code == 200:
                result = response.json()
                if result.get("success"):
                    clash_config = result.get("data", "")
                    
                    # Ê∑ªÂä†Êó∂Èó¥Â§áÊ≥®
                    beijing_time = "${{ steps.time.outputs.BEIJING_TIME }}"
                    timestamp = "${{ steps.time.outputs.TIMESTAMP }}"
                    
                    # Âú®ÈÖçÁΩÆÂºÄÂ§¥Ê∑ªÂä†Â§áÊ≥®
                    remarked_config = f"""# Êõ¥Êñ∞Êó∂Èó¥: {beijing_time} (Âåó‰∫¨Êó∂Èó¥)
# Ê∫êËá™: https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi

{clash_config}"""
                    
                    # ‰øùÂ≠òÂà∞Êñá‰ª∂
                    with open('lzhp529.yaml', 'w', encoding='utf-8') as f:
                        f.write(remarked_config)
                    
                    print("Clash configuration generated successfully")
                else:
                    print(f"API error: {result.get('message', 'Unknown error')}")
                    exit(1)
            else:
                print(f"HTTP error: {response.status_code}")
                print(f"Response: {response.text}")
                exit(1)
                
        except Exception as e:
            print(f"Error during API conversion: {e}")
            exit(1)
EOF

    - name: Check if changes exist
      id: check-changes
      run: |
        git diff --quiet lzhp529.yaml || echo "changes_exist=true" >> $GITHUB_OUTPUT
        git status

    - name: Commit and push changes
      if: steps.check-changes.outputs.changes_exist == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add lzhp529.yaml
        
        COMMIT_TIME="${{ steps.time.outputs.COMMIT_TIME }}"
        git commit -m "üîÑ Ëá™Âä®Êõ¥Êñ∞ Clash ÈÖçÁΩÆ ($COMMIT_TIME Âåó‰∫¨Êó∂Èó¥)"
        
        # Â∞ùËØïÊé®ÈÄÅÂà∞‰ªìÂ∫ì
        attempts=0
        max_attempts=3
        while [ $attempts -lt $max_attempts ]; do
          if git push origin HEAD:${{ github.ref_name }}; then
            echo "Push successful"
            break
          else
            attempts=$((attempts+1))
            echo "Push failed, attempt $attempts of $max_attempts"
            if [ $attempts -lt $max_attempts ]; then
              echo "Waiting 10 seconds before retry..."
              sleep 10
              git pull --rebase origin ${{ github.ref_name }}
            fi
          fi
        done
        
        if [ $attempts -eq $max_attempts ]; then
          echo "Failed to push after $max_attempts attempts"
          exit 1
        fi

    - name: No changes notification
      if: steps.check-changes.outputs.changes_exist != 'true'
      run: |
        echo "No changes detected in Clash configuration. Skipping commit."
