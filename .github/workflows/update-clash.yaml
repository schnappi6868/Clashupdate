#!/usr/bin/env python3
"""
本地测试脚本，用于测试Clash配置更新功能
"""

import requests
import re
import json
from datetime import datetime
import pytz
import os

def fetch_source_links():
    """获取源链接内容"""
    source_url = "https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi"
    
    try:
        response = requests.get(source_url, timeout=10)
        response.raise_for_status()
        
        content = response.text
        lines = content.split('\n')
        urls = []
        
        for line in lines:
            line = line.strip()
            # 跳过空行和注释
            if not line or line.startswith('#') or line.startswith('//') or line.startswith('<!--'):
                continue
            
            # 提取URL
            url_match = re.search(r'(https?://[^\s<>"]+|www\.[^\s<>"]+)', line)
            if url_match:
                url = url_match.group(0)
                if not url.startswith('http'):
                    url = 'https://' + url
                urls.append(url)
        
        print(f"找到 {len(urls)} 个URL")
        return urls
        
    except Exception as e:
        print(f"获取源链接失败: {e}")
        return None

def convert_to_clash(urls):
    """通过API转换为Clash配置"""
    api_url = "https://sublink.works/api/"
    
    urls_text = '\n'.join(urls)
    data = {
        "urls": urls_text,
        "target": "clash"
    }
    
    try:
        print("正在通过API转换链接...")
        response = requests.post(api_url, json=data, headers={
            "Content-Type": "application/json",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
        }, timeout=30)
        
        response.raise_for_status()
        result = response.json()
        
        if "url" in result:
            print(f"获取Clash配置链接: {result['url']}")
            clash_response = requests.get(result['url'], timeout=30)
            clash_response.raise_for_status()
            
            return clash_response.text
        else:
            print("API响应中没有找到URL")
            return None
            
    except Exception as e:
        print(f"转换失败: {e}")
        return None

def update_config_file(clash_config, timestamp):
    """更新配置文件"""
    # 添加时间戳和源信息
    header = f"""# 更新时间: {timestamp}
# 源自网站源: https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi

"""
    
    full_config = header + clash_config
    
    # 写入文件
    with open('lzhp529.yaml', 'w', encoding='utf-8') as f:
        f.write(full_config)
    
    print(f"配置文件已更新: lzhp529.yaml")
    
    # 显示文件前几行
    print("\n配置文件预览（前10行）:")
    print("-" * 50)
    lines = full_config.split('\n')[:15]
    for line in lines:
        print(line)
    print("-" * 50)

def main():
    """主函数"""
    print("=" * 60)
    print("Clash配置更新工具")
    print("=" * 60)
    
    # 设置时区
    beijing_tz = pytz.timezone('Asia/Shanghai')
    now = datetime.now(beijing_tz)
    timestamp = now.strftime('%Y-%m-%d %H:%M:%S')
    
    print(f"当前时间（北京时间）: {timestamp}")
    
    # 1. 获取源链接
    print("\n1. 正在获取源链接...")
    urls = fetch_source_links()
    
    if not urls:
        print("❌ 未找到URL，退出")
        return
    
    print(f"✅ 成功获取 {len(urls)} 个URL")
    
    # 2. 转换为Clash配置
    print("\n2. 正在转换链接为Clash配置...")
    clash_config = convert_to_clash(urls)
    
    if not clash_config:
        print("❌ 转换失败，退出")
        return
    
    print(f"✅ 成功获取Clash配置，长度: {len(clash_config)} 字符")
    
    # 3. 更新配置文件
    print("\n3. 正在更新配置文件...")
    update_config_file(clash_config, timestamp)
    
    print("\n✅ 更新完成！")

if __name__ == "__main__":
    main()
