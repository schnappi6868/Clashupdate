name: Auto Update Clash Config

on:
  schedule:
    # æ¯éš”10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/10 * * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/clash-update.yml'

permissions:
  contents: write

env:
  TZ: Asia/Shanghai

jobs:
  update-clash:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Create update_clash.py
      run: |
        cat > update_clash.py << 'EOF'
#!/usr/bin/env python3
import os
import requests
import re
from datetime import datetime
import pytz
from urllib.parse import urlparse

def get_current_time():
    """è·å–ä¸œå…«åŒºå½“å‰æ—¶é—´"""
    tz_shanghai = pytz.timezone('Asia/Shanghai')
    return datetime.now(tz_shanghai).strftime('%Y-%m-%d %H:%M:%S')

def fetch_source_urls():
    """ä»æºURLè·å–ç½‘å€åˆ—è¡¨"""
    source_url = "https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi"
    
    try:
        response = requests.get(source_url, timeout=30)
        response.raise_for_status()
        
        content = response.text
        print(f"è·å–åˆ°åŸå§‹å†…å®¹é•¿åº¦: {len(content)} å­—ç¬¦")
        
        urls = []
        lines = content.split('\n')
        
        for line in lines:
            line = line.strip()
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            if not line or line.startswith('#') or 'å¤‡æ³¨' in line:
                continue
            
            # æå–ç½‘å€
            url_match = re.search(r'(https?://[^\s<>"\']+)', line)
            if url_match:
                url = url_match.group(1)
                urls.append(url)
                print(f"æ‰¾åˆ°URL: {url}")
        
        return urls
    except Exception as e:
        print(f"è·å–æºURLå¤±è´¥: {e}")
        return []

def save_subscription_links(urls):
    """ä¿å­˜è®¢é˜…é“¾æ¥åˆ°æ–‡ä»¶"""
    current_time = get_current_time()
    
    content = f"# æ›´æ–°æ—¶é—´: {current_time} (UTC+8)\n"
    content += f"# æºè‡ª: https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi\n\n"
    
    if urls:
        content += "\n".join(urls)
    else:
        content += "# æš‚æ— è®¢é˜…é“¾æ¥"
    
    with open("è®¢é˜…é“¾æ¥.txt", "w", encoding="utf-8") as f:
        f.write(content)
    
    print(f"å·²ä¿å­˜ {len(urls)} ä¸ªé“¾æ¥åˆ° è®¢é˜…é“¾æ¥.txt")
    return content

def convert_to_clash_config(urls):
    """ä½¿ç”¨sublink APIè½¬æ¢ä¸ºClashé…ç½®"""
    print(f"å¼€å§‹è½¬æ¢ {len(urls)} ä¸ªURLä¸ºClashé…ç½®")
    
    if not urls:
        print("æ²¡æœ‰URLéœ€è¦è½¬æ¢")
        return generate_fallback_config(urls)
    
    # å°è¯•ç›´æ¥è°ƒç”¨è½¬æ¢API
    try:
        api_url = "https://sublink-worker.schnappi6868.workers.dev/"
        urls_text = "\n".join(urls)
        
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Content-Type': 'application/x-www-form-urlencoded',
        }
        
        print("æ­£åœ¨è°ƒç”¨sublinkè½¬æ¢API...")
        
        # å°è¯•POSTè¯·æ±‚
        response = requests.post(
            api_url, 
            data={'urls': urls_text, 'config': 'clash'},
            headers=headers,
            timeout=60
        )
        
        print(f"APIå“åº”çŠ¶æ€: {response.status_code}")
        
        if response.status_code == 200:
            clash_config = response.text
            # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„Clashé…ç½®
            if 'proxies:' in clash_config or 'port:' in clash_config:
                print("æˆåŠŸè·å–åˆ°æœ‰æ•ˆçš„Clashé…ç½®")
                return clash_config
        
    except Exception as e:
        print(f"APIè½¬æ¢å¤±è´¥: {e}")
    
    print("ä½¿ç”¨å¤‡ç”¨é…ç½®ç”Ÿæˆ")
    return generate_fallback_config(urls)

def generate_fallback_config(urls):
    """ç”Ÿæˆå¤‡ç”¨Clashé…ç½®"""
    current_time = get_current_time()
    
    config = f"""# Clash é…ç½®æ–‡ä»¶
# æ›´æ–°æ—¶é—´: {current_time} (UTC+8)
# æºè‡ª: https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi

port: 7890
socks-port: 7891
allow-lan: true
mode: Rule
log-level: info
external-controller: 0.0.0.0:9090

proxies:
"""
    
    if urls:
        for i, url in enumerate(urls, 1):
            try:
                parsed = urlparse(url)
                domain = parsed.netloc
                config += f"""
  - name: èŠ‚ç‚¹{i}
    type: ss
    server: {domain}
    port: 443
    cipher: aes-256-gcm
    password: "password"
"""
            except:
                config += f"""
  - name: èŠ‚ç‚¹{i}
    type: ss
    server: server{i}.example.com
    port: 443
    cipher: aes-256-gcm
    password: "password"
"""
    else:
        config += """
  - name: ç¤ºä¾‹èŠ‚ç‚¹
    type: ss
    server: example.com
    port: 443
    cipher: aes-256-gcm
    password: "password"
"""

    config += """
proxy-groups:
  - name: ğŸš€ è‡ªåŠ¨é€‰æ‹©
    type: url-test
    url: http://www.gstatic.com/generate_204
    interval: 300
    tolerance: 50
    proxies:
"""
    
    if urls:
        for i in range(1, len(urls) + 1):
            config += f"      - èŠ‚ç‚¹{i}\n"
    else:
        config += "      - ç¤ºä¾‹èŠ‚ç‚¹\n"

    config += """
  - name: ğŸŒ å›½å¤–ç½‘ç«™
    type: select
    proxies:
      - ğŸš€ è‡ªåŠ¨é€‰æ‹©
      - DIRECT

rules:
  - DOMAIN-SUFFIX,google.com,ğŸŒ å›½å¤–ç½‘ç«™
  - DOMAIN-SUFFIX,youtube.com,ğŸŒ å›½å¤–ç½‘ç«™
  - DOMAIN-SUFFIX,github.com,ğŸŒ å›½å¤–ç½‘ç«™
  - GEOIP,CN,DIRECT
  - MATCH,ğŸŒ å›½å¤–ç½‘ç«™
"""
    
    return config

def save_clash_config(config):
    """ä¿å­˜Clashé…ç½®åˆ°æ–‡ä»¶"""
    with open("lzhp529.yaml", "w", encoding="utf-8") as f:
        f.write(config)
    print(f"Clashé…ç½®å·²ä¿å­˜åˆ° lzhp529.yaml")

def main():
    print("=" * 50)
    print("Clashé…ç½®æ›´æ–°å·¥å…·")
    print(f"å¼€å§‹æ—¶é—´: {get_current_time()}")
    print("=" * 50)
    
    # æ­¥éª¤1ï¼šè·å–ç½‘å€
    print("\n[æ­¥éª¤1] ä»GitHubè·å–è®¢é˜…é“¾æ¥...")
    urls = fetch_source_urls()
    print(f"æ‰¾åˆ° {len(urls)} ä¸ªè®¢é˜…é“¾æ¥")
    
    # ä¿å­˜è®¢é˜…é“¾æ¥
    print("\n[æ­¥éª¤2] ä¿å­˜è®¢é˜…é“¾æ¥åˆ°æ–‡ä»¶...")
    save_subscription_links(urls)
    
    # æ­¥éª¤2ï¼šè½¬æ¢ä¸ºClashé…ç½®
    print("\n[æ­¥éª¤3] è½¬æ¢ä¸ºClashé…ç½®...")
    clash_config = convert_to_clash_config(urls)
    
    # ä¿å­˜Clashé…ç½®
    print("\n[æ­¥éª¤4] ä¿å­˜Clashé…ç½®æ–‡ä»¶...")
    save_clash_config(clash_config)
    
    print("\n" + "=" * 50)
    print("æ›´æ–°å®Œæˆ!")
    print(f"å®Œæˆæ—¶é—´: {get_current_time()}")
    print("=" * 50)

if __name__ == "__main__":
    main()
EOF
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pytz
        
    - name: Create initial files if not exist
      run: |
        # åˆ›å»ºå¿…è¦çš„åˆå§‹æ–‡ä»¶
        if [ ! -f "è®¢é˜…é“¾æ¥.txt" ]; then
          echo "# åˆå§‹è®¢é˜…é“¾æ¥æ–‡ä»¶" > "è®¢é˜…é“¾æ¥.txt"
        fi
        if [ ! -f "lzhp529.yaml" ]; then
          echo "# åˆå§‹Clashé…ç½®æ–‡ä»¶" > "lzhp529.yaml"
        fi
        
    - name: Run update script
      run: |
        python3 update_clash.py
        
    - name: Check for changes
      run: |
        echo "å½“å‰ç›®å½•:"
        pwd
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "è®¢é˜…é“¾æ¥.txtå†…å®¹:"
        cat "è®¢é˜…é“¾æ¥.txt" || echo "æ–‡ä»¶ä¸å­˜åœ¨"
        echo "lzhp529.yamlå†…å®¹å‰10è¡Œ:"
        head -10 "lzhp529.yaml" || echo "æ–‡ä»¶ä¸å­˜åœ¨"
        
    - name: Commit and push if changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .
        
        if ! git diff --cached --quiet; then
          current_time=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "ğŸ”„ Auto update: $current_time (UTC+8)"
          git push
          echo "å·²æäº¤æ›´æ”¹"
        else
          echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        fi
