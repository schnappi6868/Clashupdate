name: Update Clash Config

on:
  schedule:
    # æ¯éš”10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - cron: '*/10 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main

jobs:
  update-config:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: èŽ·å–å¹¶è½¬æ¢é“¾æŽ¥
      id: process-links
      run: |
        # å®‰è£…å¿…è¦çš„PythonåŒ…
        pip install requests
        
        # åˆ›å»ºPythonè„šæœ¬èŽ·å–é“¾æŽ¥
        cat > fetch_urls.py << 'EOF'
        import requests
        import re
        from datetime import datetime
        import time
        
        def fetch_links():
            source_url = "https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi"
            
            try:
                response = requests.get(source_url, timeout=10)
                response.raise_for_status()
                
                content = response.text
                lines = content.split('\n')
                urls = []
                
                for line in lines:
                    line = line.strip()
                    # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
                    if not line:
                        continue
                    if line.startswith('#') or line.startswith('//') or line.startswith('<!--'):
                        continue
                    
                    # æå–URLï¼ˆç®€å•çš„URLåŒ¹é…ï¼‰
                    url_match = re.search(r'(https?://[^\s<>"]+|www\.[^\s<>"]+)', line)
                    if url_match:
                        url = url_match.group(0)
                        if not url.startswith('http'):
                            url = 'https://' + url
                        urls.append(url)
                
                return urls
                
            except Exception as e:
                print(f"Error fetching source: {e}")
                return None
        
        if __name__ == "__main__":
            urls = fetch_links()
            if urls:
                # å°†URLåˆ—è¡¨è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œæ¯è¡Œä¸€ä¸ª
                urls_text = '\n'.join(urls)
                
                # èŽ·å–å½“å‰åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
                utc_time = datetime.utcnow()
                # è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
                beijing_time = utc_time.replace(hour=(utc_time.hour + 8) % 24)
                timestamp = beijing_time.strftime('%Y-%m-%d %H:%M:%S')
                
                # è¾“å‡ºåˆ°GitHub Actions
                print(f"::set-output name=urls::{urls_text}")
                print(f"::set-output name=timestamp::{timestamp}")
                print(f"Found {len(urls)} URLs")
            else:
                print("No URLs found")
                exit(1)
        EOF
        
        # è¿è¡ŒPythonè„šæœ¬èŽ·å–URLs
        python fetch_urls.py
        
        # èŽ·å–è¾“å‡ºå˜é‡
        urls="${{ steps.process-links.outputs.urls }}"
        timestamp="${{ steps.process-links.outputs.timestamp }}"
        
        echo "èŽ·å–åˆ°çš„æ—¶é—´æˆ³: $timestamp"
        echo "èŽ·å–åˆ°çš„URLæ•°é‡: $(echo "$urls" | wc -l)"

    - name: é€šè¿‡APIè½¬æ¢é“¾æŽ¥
      id: convert-links
      run: |
        # ç¡®ä¿å®‰è£…äº†requests
        pip install requests
        
        cat > convert_links.py << 'EOF'
        import requests
        import json
        import os
        import sys
        
        def convert_links(urls_text):
            api_url = "https://sublink.works/api/"
            
            # æž„å»ºè¯·æ±‚æ•°æ®
            data = {
                "urls": urls_text,
                "target": "clash"
            }
            
            try:
                print("æ­£åœ¨å‘é€è¯·æ±‚åˆ°API...")
                response = requests.post(api_url, json=data, headers={
                    "Content-Type": "application/json",
                    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
                }, timeout=30)
                
                print(f"APIå“åº”çŠ¶æ€ç : {response.status_code}")
                
                if response.status_code == 200:
                    result = response.json()
                    print(f"APIå“åº”: {json.dumps(result, ensure_ascii=False)[:200]}...")
                    
                    if "url" in result:
                        # èŽ·å–è½¬æ¢åŽçš„Clashé“¾æŽ¥
                        clash_url = result["url"]
                        print(f"èŽ·å–Clashé…ç½®é“¾æŽ¥: {clash_url}")
                        
                        clash_response = requests.get(clash_url, timeout=30)
                        print(f"Clashé…ç½®å“åº”çŠ¶æ€ç : {clash_response.status_code}")
                        
                        if clash_response.status_code == 200:
                            return clash_response.text
                        else:
                            print(f"Error fetching Clash config: {clash_response.status_code}")
                            print(f"å“åº”å†…å®¹: {clash_response.text[:500]}")
                            return None
                    else:
                        print("No URL in API response")
                        return None
                else:
                    print(f"API Error: {response.status_code}")
                    print(f"Response: {response.text[:500]}")
                    return None
                    
            except Exception as e:
                print(f"Exception during conversion: {str(e)}")
                import traceback
                traceback.print_exc()
                return None
        
        if __name__ == "__main__":
            # ä»ŽçŽ¯å¢ƒå˜é‡æˆ–å‘½ä»¤è¡Œå‚æ•°èŽ·å–URLs
            if len(sys.argv) > 1:
                urls_text = sys.argv[1]
            else:
                # å°è¯•ä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–
                urls_text = os.environ.get('URLS_TEXT', '')
            
            if not urls_text:
                print("No URLs provided")
                sys.exit(1)
            
            print(f"æ”¶åˆ°URLsæ–‡æœ¬é•¿åº¦: {len(urls_text)}")
            print(f"å‰500å­—ç¬¦: {urls_text[:500]}")
            
            clash_config = convert_links(urls_text)
            if clash_config:
                print(f"æˆåŠŸèŽ·å–Clashé…ç½®ï¼Œé•¿åº¦: {len(clash_config)} å­—ç¬¦")
                print("::set-output name=clash_config::" + clash_config.replace('\n', '%0A').replace('\r', '%0D'))
            else:
                print("Failed to convert links")
                sys.exit(1)
        EOF
        
        # ä½¿ç”¨ä¸Šä¸€æ­¥èŽ·å–çš„URLs
        urls="${{ steps.process-links.outputs.urls }}"
        
        if [ -z "$urls" ]; then
          echo "No URLs to convert"
          exit 1
        fi
        
        echo "URLså†…å®¹:"
        echo "$urls"
        
        # å¯¼å‡ºçŽ¯å¢ƒå˜é‡ä¾›Pythonè„šæœ¬ä½¿ç”¨
        export URLS_TEXT="$urls"
        
        # è°ƒç”¨APIè½¬æ¢
        python convert_links.py "$urls"

    - name: æ›´æ–°é…ç½®æ–‡ä»¶
      id: update-config
      run: |
        timestamp="${{ steps.process-links.outputs.timestamp }}"
        
        # èŽ·å–Clashé…ç½®ï¼ˆéœ€è¦å¤„ç†æ¢è¡Œç¬¦ï¼‰
        clash_config_raw="${{ steps.convert-links.outputs.clash_config }}"
        
        # å°†URLç¼–ç çš„æ¢è¡Œç¬¦è½¬æ¢å›žæ¥
        clash_config=$(echo "$clash_config_raw" | sed 's/%0A/\n/g' | sed 's/%0D/\r/g')
        
        if [ -z "$clash_config" ]; then
          echo "No Clash config to update"
          exit 1
        fi
        
        echo "Clashé…ç½®é•¿åº¦: ${#clash_config} å­—ç¬¦"
        
        # åˆ›å»ºæ›´æ–°åŽçš„å†…å®¹
        cat > lzhp529.yaml << EOF
# æ›´æ–°æ—¶é—´: $timestamp
# æºè‡ªç½‘ç«™æº: https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi

$clash_config
EOF
        
        # æ˜¾ç¤ºå‰å‡ è¡Œç¡®è®¤å†…å®¹
        echo "æ›´æ–°åŽçš„é…ç½®æ–‡ä»¶å‰20è¡Œ:"
        head -n 20 lzhp529.yaml
        echo "..."

    - name: æäº¤æ›´æ–°
      run: |
        # é…ç½®Git
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet lzhp529.yaml; then
          echo "No changes detected"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        timestamp="${{ steps.process-links.outputs.timestamp }}"
        git add lzhp529.yaml
        git commit -m "ðŸ”„ è‡ªåŠ¨æ›´æ–° Clash é…ç½® - $timestamp"
        
        # æŽ¨é€æ›´æ”¹ï¼ˆéœ€è¦è®¾ç½®tokenæƒé™ï¼‰
        git push
