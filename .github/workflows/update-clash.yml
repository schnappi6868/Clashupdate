name: Update Clash Config

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests

    - name: Fetch URLs
      id: fetch
      run: |
        python << 'EOF'
import requests
import re
from datetime import datetime
import os

def main():
    # èŽ·å–æºæ–‡ä»¶
    url = "https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi"
    resp = requests.get(url)
    
    if resp.status_code != 200:
        print(f"Error: {resp.status_code}")
        exit(1)
    
    # æå–URLs
    urls = []
    for line in resp.text.splitlines():
        line = line.strip()
        if not line or line.startswith(('#', '//', '<!--')):
            continue
        
        match = re.search(r'https?://[^\s<>"]+', line)
        if match:
            urls.append(match.group(0))
    
    if not urls:
        print("No URLs found")
        exit(1)
    
    # å‡†å¤‡è¾“å‡º
    urls_text = '\n'.join(urls)
    
    # åŒ—äº¬æ—¶é—´
    utc_now = datetime.utcnow()
    beijing_time = utc_now.replace(hour=(utc_now.hour + 8) % 24)
    timestamp = beijing_time.strftime('%Y-%m-%d %H:%M:%S')
    
    # è®¾ç½®è¾“å‡º
    with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
        print(f"urls={urls_text}", file=f)
        print(f"timestamp={timestamp}", file=f)
    
    print(f"Found {len(urls)} URLs")

if __name__ == "__main__":
    main()
EOF

    - name: Convert via API
      id: convert
      run: |
        python << 'EOF'
import requests
import json
import os

# ä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–URLs
urls_text = """${{ steps.fetch.outputs.urls }}"""

# è°ƒç”¨API
api_url = "https://sublink.works/api/"
data = {
    "urls": urls_text,
    "target": "clash"
}

try:
    resp = requests.post(api_url, json=data, timeout=30)
    if resp.status_code == 200:
        result = resp.json()
        if "url" in result:
            # èŽ·å–Clashé…ç½®
            clash_resp = requests.get(result["url"], timeout=30)
            if clash_resp.status_code == 200:
                # ä¿å­˜åˆ°æ–‡ä»¶
                with open("clash_config.txt", "w") as f:
                    f.write(clash_resp.text)
                print("Conversion successful")
            else:
                print(f"Failed to fetch Clash config: {clash_resp.status_code}")
                exit(1)
        else:
            print("No URL in response")
            exit(1)
    else:
        print(f"API error: {resp.status_code}")
        exit(1)
except Exception as e:
    print(f"Error: {e}")
    exit(1)
EOF

    - name: Update config file
      run: |
        # è¯»å–Clashé…ç½®
        CLASH_CONFIG=$(cat clash_config.txt)
        TIMESTAMP="${{ steps.fetch.outputs.timestamp }}"
        
        # åˆ›å»ºæ–°é…ç½®æ–‡ä»¶
        {
          echo "# æ›´æ–°æ—¶é—´: $TIMESTAMP"
          echo "# æºè‡ªç½‘ç«™æº: https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi"
          echo ""
          echo "$CLASH_CONFIG"
        } > lzhp529.yaml

    - name: Commit and push
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        git add lzhp529.yaml
        
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          TIMESTAMP="${{ steps.fetch.outputs.timestamp }}"
          git commit -m "ðŸ”„ Auto update: $TIMESTAMP"
          git push
        fi
