name: Update Clash Config

on:
  schedule:
    # æ¯éš”10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - cron: '*/10 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main

jobs:
  update-config:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: è·å–å¹¶è½¬æ¢é“¾æ¥
      id: process-links
      run: |
        # å®‰è£…å¿…è¦çš„PythonåŒ…
        pip install requests
        
        # åˆ›å»ºPythonè„šæœ¬è·å–é“¾æ¥
        cat > fetch_urls.py << 'EOF'
import requests
import re
from datetime import datetime
import time

def fetch_links():
    source_url = "https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi"
    
    try:
        response = requests.get(source_url, timeout=10)
        response.raise_for_status()
        
        content = response.text
        lines = content.split('\n')
        urls = []
        
        for line in lines:
            line = line.strip()
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            if not line:
                continue
            if line.startswith('#') or line.startswith('//') or line.startswith('<!--'):
                continue
            
            # æå–URLï¼ˆç®€å•çš„URLåŒ¹é…ï¼‰
            url_match = re.search(r'(https?://[^\s<>"]+|www\.[^\s<>"]+)', line)
            if url_match:
                url = url_match.group(0)
                if not url.startswith('http'):
                    url = 'https://' + url
                urls.append(url)
        
        return urls
        
    except Exception as e:
        print(f"Error fetching source: {e}")
        return None

if __name__ == "__main__":
    urls = fetch_links()
    if urls:
        # å°†URLåˆ—è¡¨è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œæ¯è¡Œä¸€ä¸ª
        urls_text = '\n'.join(urls)
        
        # è·å–å½“å‰åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
        utc_time = datetime.utcnow()
        # è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
        beijing_hour = (utc_time.hour + 8) % 24
        beijing_time = utc_time.replace(hour=beijing_hour)
        timestamp = beijing_time.strftime('%Y-%m-%d %H:%M:%S')
        
        # è¾“å‡ºåˆ°GitHub Actions (æ—§æ–¹æ³•)
        with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
            print(f"urls={urls_text}", file=fh)
            print(f"timestamp={timestamp}", file=fh)
        
        print(f"Found {len(urls)} URLs")
    else:
        print("No URLs found")
        exit(1)
EOF
        
        # è¿è¡ŒPythonè„šæœ¬è·å–URLs
        python fetch_urls.py

    - name: é€šè¿‡APIè½¬æ¢é“¾æ¥
      id: convert-links
      run: |
        # ç¡®ä¿å®‰è£…äº†requests
        pip install requests
        
        cat > convert_links.py << 'EOF'
import requests
import json
import os
import sys

def convert_links(urls_text):
    api_url = "https://sublink.works/api/"
    
    # æ„å»ºè¯·æ±‚æ•°æ®
    data = {
        "urls": urls_text,
        "target": "clash"
    }
    
    try:
        print("æ­£åœ¨å‘é€è¯·æ±‚åˆ°API...")
        response = requests.post(api_url, json=data, headers={
            "Content-Type": "application/json",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
        }, timeout=30)
        
        print(f"APIå“åº”çŠ¶æ€ç : {response.status_code}")
        
        if response.status_code == 200:
            result = response.json()
            print(f"APIå“åº”æˆåŠŸ")
            
            if "url" in result:
                # è·å–è½¬æ¢åçš„Clashé“¾æ¥
                clash_url = result["url"]
                print(f"è·å–Clashé…ç½®é“¾æ¥: {clash_url}")
                
                clash_response = requests.get(clash_url, timeout=30)
                print(f"Clashé…ç½®å“åº”çŠ¶æ€ç : {clash_response.status_code}")
                
                if clash_response.status_code == 200:
                    return clash_response.text
                else:
                    print(f"Error fetching Clash config: {clash_response.status_code}")
                    return None
            else:
                print("No URL in API response")
                return None
        else:
            print(f"API Error: {response.status_code}")
            return None
            
    except Exception as e:
        print(f"Exception during conversion: {str(e)}")
        return None

if __name__ == "__main__":
    # ä»ç¯å¢ƒå˜é‡è·å–URLs
    urls_text = os.environ.get('URLS_TEXT', '')
    
    if not urls_text:
        print("No URLs provided")
        sys.exit(1)
    
    print(f"æ”¶åˆ°URLsæ–‡æœ¬é•¿åº¦: {len(urls_text)}")
    
    clash_config = convert_links(urls_text)
    if clash_config:
        print(f"æˆåŠŸè·å–Clashé…ç½®ï¼Œé•¿åº¦: {len(clash_config)} å­—ç¬¦")
        # ä¿å­˜åˆ°æ–‡ä»¶ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        with open('clash_config.txt', 'w', encoding='utf-8') as f:
            f.write(clash_config)
    else:
        print("Failed to convert links")
        sys.exit(1)
EOF
        
        # è·å–ä¸Šä¸€æ­¥çš„URLsè¾“å‡º
        echo "URLS_TEXT=${{ steps.process-links.outputs.urls }}" >> $GITHUB_ENV
        
        # è°ƒç”¨APIè½¬æ¢
        python convert_links.py
        
        # è¯»å–ç”Ÿæˆçš„é…ç½®
        if [ -f "clash_config.txt" ]; then
          CLASH_CONFIG=$(cat clash_config.txt)
          echo "CLASH_CONFIG<<EOF" >> $GITHUB_ENV
          echo "$CLASH_CONFIG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        fi

    - name: æ›´æ–°é…ç½®æ–‡ä»¶
      id: update-config
      run: |
        timestamp="${{ steps.process-links.outputs.timestamp }}"
        clash_config="${{ env.CLASH_CONFIG }}"
        
        if [ -z "$clash_config" ]; then
          echo "No Clash config to update"
          exit 1
        fi
        
        echo "Clashé…ç½®é•¿åº¦: ${#clash_config} å­—ç¬¦"
        
        # åˆ›å»ºæ›´æ–°åçš„å†…å®¹
        {
          echo "# æ›´æ–°æ—¶é—´: $timestamp"
          echo "# æºè‡ªç½‘ç«™æº: https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi"
          echo ""
          echo "$clash_config"
        } > lzhp529.yaml
        
        # æ˜¾ç¤ºå‰å‡ è¡Œç¡®è®¤å†…å®¹
        echo "æ›´æ–°åçš„é…ç½®æ–‡ä»¶å‰20è¡Œ:"
        head -n 20 lzhp529.yaml
        echo "..."

    - name: é…ç½®Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: æäº¤æ›´æ–°
      run: |
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet lzhp529.yaml; then
          echo "No changes detected"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        timestamp="${{ steps.process-links.outputs.timestamp }}"
        git add lzhp529.yaml
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–° Clash é…ç½® - $timestamp"
        
        # æ¨é€æ›´æ”¹
        git push
