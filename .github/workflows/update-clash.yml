name: Update Clash Config

on:
  schedule:
    # ÊØèÈöî10ÂàÜÈíüËøêË°å‰∏ÄÊ¨°ÔºàÂåó‰∫¨Êó∂Èó¥Ôºâ
    - cron: '*/10 * * * *'
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
  push:
    branches:
      - main

jobs:
  update-config:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml pyyaml

    - name: Ëé∑ÂèñÊ∫êÈìæÊé•ÂÜÖÂÆπ
      id: fetch-source
      run: |
        cat > fetch_links.py << 'EOF'
        import requests
        import re
        from datetime import datetime
        import pytz
        
        # ËÆæÁΩÆÊó∂Âå∫‰∏∫‰∏úÂÖ´Âå∫ÔºàÂåó‰∫¨Êó∂Èó¥Ôºâ
        beijing_tz = pytz.timezone('Asia/Shanghai')
        
        def fetch_links():
            source_url = "https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi"
            response = requests.get(source_url)
            
            if response.status_code != 200:
                print(f"Error fetching source: {response.status_code}")
                return None
            
            content = response.text
            
            # ÊèêÂèñÈô§Â§áÊ≥®Ê≥®ÈáäÂ§ñÁöÑÊâÄÊúâÁΩëÂùÄ
            # ÂÅáËÆæÊ≥®Èáä‰ª•#„ÄÅ//„ÄÅÊàñ<!--ÂºÄÂ§¥
            lines = content.split('\n')
            urls = []
            
            for line in lines:
                line = line.strip()
                # Ë∑≥ËøáÁ©∫Ë°åÂíåÊ≥®Èáä
                if not line or line.startswith('#') or line.startswith('//') or line.startswith('<!--'):
                    continue
                # ÊèêÂèñURLÔºàÁÆÄÂçïÁöÑURLÂåπÈÖçÔºâ
                url_match = re.search(r'(https?://[^\s<>"]+|www\.[^\s<>"]+)', line)
                if url_match:
                    url = url_match.group(0)
                    if not url.startswith('http'):
                        url = 'https://' + url
                    urls.append(url)
            
            return urls
        
        if __name__ == "__main__":
            urls = fetch_links()
            if urls:
                # Â∞ÜURLÂàóË°®ËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤ÔºåÊØèË°å‰∏Ä‰∏™
                urls_text = '\n'.join(urls)
                
                # Ëé∑ÂèñÂΩìÂâçÂåó‰∫¨Êó∂Èó¥
                now = datetime.now(beijing_tz)
                timestamp = now.strftime('%Y-%m-%d %H:%M:%S')
                
                print(f"::set-output name=urls::{urls_text}")
                print(f"::set-output name=timestamp::{timestamp}")
                print(f"Found {len(urls)} URLs")
            else:
                print("No URLs found")
        EOF
        
        python fetch_links.py >> output.txt
        urls=$(python -c "
        import sys
        exec(open('fetch_links.py').read())
        if __name__ == '__main__':
            urls = fetch_links()
            if urls:
                print('\\n'.join(urls))
        ")
        timestamp=$(python -c "
        from datetime import datetime
        import pytz
        beijing_tz = pytz.timezone('Asia/Shanghai')
        now = datetime.now(beijing_tz)
        print(now.strftime('%Y-%m-%d %H:%M:%S'))
        ")
        
        echo "urls<<EOF" >> $GITHUB_OUTPUT
        echo "$urls" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "timestamp<<EOF" >> $GITHUB_OUTPUT
        echo "$timestamp" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ÈÄöËøáAPIËΩ¨Êç¢ÈìæÊé•
      id: convert-links
      run: |
        cat > convert_links.py << 'EOF'
        import requests
        import json
        import sys
        
        def convert_links(urls_text):
            api_url = "https://sublink.works/api/"
            
            # ÊûÑÂª∫ËØ∑Ê±ÇÊï∞ÊçÆ
            data = {
                "urls": urls_text,
                "target": "clash"
            }
            
            try:
                response = requests.post(api_url, json=data, headers={
                    "Content-Type": "application/json",
                    "User-Agent": "Mozilla/5.0"
                })
                
                if response.status_code == 200:
                    result = response.json()
                    if "url" in result:
                        # Ëé∑ÂèñËΩ¨Êç¢ÂêéÁöÑClashÈìæÊé•
                        clash_url = result["url"]
                        clash_response = requests.get(clash_url)
                        
                        if clash_response.status_code == 200:
                            return clash_response.text
                        else:
                            print(f"Error fetching Clash config: {clash_response.status_code}")
                            return None
                    else:
                        print("No URL in API response")
                        return None
                else:
                    print(f"API Error: {response.status_code}")
                    print(f"Response: {response.text}")
                    return None
                    
            except Exception as e:
                print(f"Exception during conversion: {str(e)}")
                return None
        
        if __name__ == "__main__":
            urls_text = sys.argv[1] if len(sys.argv) > 1 else ""
            if urls_text:
                clash_config = convert_links(urls_text)
                if clash_config:
                    print(clash_config)
        EOF
        
        # ‰ΩøÁî®‰∏ä‰∏ÄÊ≠•Ëé∑ÂèñÁöÑURLs
        urls="${{ steps.fetch-source.outputs.urls }}"
        
        if [ -z "$urls" ]; then
          echo "No URLs to convert"
          exit 1
        fi
        
        # Ë∞ÉÁî®APIËΩ¨Êç¢
        clash_config=$(python convert_links.py "$urls")
        
        if [ -n "$clash_config" ]; then
          echo "clash_config<<EOF" >> $GITHUB_OUTPUT
          echo "$clash_config" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "Failed to convert links"
          exit 1
        fi

    - name: Êõ¥Êñ∞ÈÖçÁΩÆÊñá‰ª∂
      id: update-config
      run: |
        timestamp="${{ steps.fetch-source.outputs.timestamp }}"
        clash_config="${{ steps.convert-links.outputs.clash_config }}"
        
        if [ -z "$clash_config" ]; then
          echo "No Clash config to update"
          exit 1
        fi
        
        # ÂàõÂª∫Êõ¥Êñ∞ÂêéÁöÑÂÜÖÂÆπ
        cat > lzhp529.yaml << 'EOF'
        # Êõ¥Êñ∞Êó∂Èó¥: $timestamp
        # Ê∫êËá™ÁΩëÁ´ôÊ∫ê: https://raw.githubusercontent.com/cler1818/Note/refs/heads/main/ceshi
        
        $clash_config
        EOF
        
        # ÊòæÁ§∫ÂâçÂá†Ë°åÁ°ÆËÆ§ÂÜÖÂÆπ
        echo "Updated config first 10 lines:"
        head -n 10 lzhp529.yaml

    - name: Êèê‰∫§Êõ¥Êñ∞
      run: |
        # ÈÖçÁΩÆGit
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶ÊúâÂèòÂåñ
        if git diff --quiet lzhp529.yaml; then
          echo "No changes detected"
          exit 0
        fi
        
        # Êèê‰∫§Êõ¥Êîπ
        timestamp="${{ steps.fetch-source.outputs.timestamp }}"
        git add lzhp529.yaml
        git commit -m "üîÑ Ëá™Âä®Êõ¥Êñ∞ Clash ÈÖçÁΩÆ - $timestamp"
        git push
